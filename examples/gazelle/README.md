# Gazelle Example for rules_cue

This example demonstrates how to use [Gazelle](https://github.com/bazelbuild/bazel-gazelle) to automatically generate Bazel BUILD files for CUE code.

## Overview

Gazelle is a build file generator for Bazel projects. The `rules_cue` Gazelle extension can automatically generate:

- `cue_instance` rules for CUE packages
- `cue_module` rules for `cue.mod` directories
- `cue_consolidated_instance` rules for consolidated output
- `cue_exported_instance` rules for exporting to various formats

## Project Structure

```
examples/gazelle/
├── MODULE.bazel              # Bazel module configuration
├── BUILD.bazel               # Root BUILD file with Gazelle targets
├── README.md                 # This file
├── cue.mod/
│   ├── module.cue           # CUE module definition
│   └── BUILD.bazel          # Generated by Gazelle
└── contacts/
    ├── schema.cue           # CUE schema definition
    ├── data.cue             # CUE data
    └── BUILD.bazel          # Generated by Gazelle
```

## Usage

### Generate BUILD files

To generate or update BUILD.bazel files for your CUE code:

```bash
bazel run //:gazelle
```

This will scan all `.cue` files in the project and generate appropriate Bazel rules.

### Verify BUILD files are up to date

To check if BUILD files are in sync with your CUE code (useful in CI):

```bash
bazel run //:gazelle_check
```

### Test the generated rules

After generating BUILD files, you can build and test your CUE code:

```bash
# Build a specific CUE instance
bazel build //contacts:contacts_cue_instance

# Export CUE to JSON
bazel build //contacts:contacts_cue_def

# Build everything
bazel build //...

# Run tests
bazel test //...
```

## Gazelle Directives

You can customize Gazelle behavior using directives in BUILD.bazel files:

### Common Directives

```python
# Set the import path prefix
# gazelle:prefix github.com/example/project

# Control output format for CUE exports (json, yaml, or text)
# gazelle:cue_output_format yaml

# Generate cue_exported_instance rules
# gazelle:cue_gen_exported_instance

# Configure golden file testing
# gazelle:cue_test_golden_suffix -golden.json
```

### Example with Directives

```python
# In contacts/BUILD.bazel

# gazelle:cue_output_format yaml

# The rules below will be generated by Gazelle
```

## Configuration in MODULE.bazel

The Gazelle extension is configured in `MODULE.bazel`:

```python
bazel_dep(name = "rules_cue", version = "0.0.0")
bazel_dep(name = "gazelle", version = "0.47.0")

# Go dependencies needed for the Gazelle extension
go_deps = use_extension("@gazelle//:extensions.bzl", "go_deps")
go_deps.from_file(go_mod = "@rules_cue//:go.mod")
use_repo(go_deps, "com_github_iancoleman_strcase", "org_cuelang_go")
```

## Generated Rules

Gazelle will generate the following types of rules:

### cue_module

Generated in `cue.mod/BUILD.bazel`:

```python
load("@rules_cue//cue:cue.bzl", "cue_module")

cue_module(
    name = "cue.mod",
    visibility = ["//visibility:public"],
)
```

### cue_instance

Generated for each CUE package:

```python
cue_instance(
    name = "contacts_cue_instance",
    srcs = [
        "data.cue",
        "schema.cue",
    ],
    ancestor = "//cue.mod:cue.mod",
    package_name = "contacts",
    visibility = ["//visibility:public"],
)
```

### cue_consolidated_instance

Generated to consolidate CUE instances to a single `.cue` file:

```python
cue_consolidated_instance(
    name = "contacts_cue_def",
    instance = ":contacts_cue_instance",
    output_format = "cue",
    visibility = ["//visibility:public"],
)
```

## Benefits

- **Automation**: No need to manually write BUILD files for CUE code
- **Consistency**: Ensures BUILD files follow a consistent pattern
- **Maintenance**: Easy to keep BUILD files in sync with CUE code changes
- **CI Integration**: Can verify BUILD files are up to date in CI pipelines

## Testing the Example

After setting up the example, you can verify it works:

```bash
# Build all targets
bazel build //...

# View the consolidated CUE output
bazel build //contacts:contacts_cue_def
cat bazel-bin/contacts/contacts_cue_def.cue

# Build the API service configuration
bazel build //services/api:api_cue_def
cat bazel-bin/services/api/api_cue_def.cue
```

## Modifying the Example

Try adding new CUE files or packages:

1. Create a new `.cue` file in any directory
2. Run `bazel run //:gazelle` to generate BUILD files
3. Build your new target: `bazel build //path/to/package:target_name`

For example, create `inventory/products.cue`:

```cue
package inventory

#Product: {
    id:    string
    name:  string
    price: number & >0
}

products: [...#Product]
products: [
    {id: "001", name: "Widget", price: 9.99},
    {id: "002", name: "Gadget", price: 19.99},
]
```

Then run:

```bash
bazel run //:gazelle
bazel build //inventory:inventory_cue_instance
```

## Common Issues

### Gazelle not finding CUE files

Make sure your CUE files have the `.cue` extension and contain valid CUE code with a package declaration.

### Build failures

If builds fail after running Gazelle:

1. Check that all CUE files in a package have the same package name
2. Verify imports are correct
3. Ensure `cue.mod/module.cue` exists if using module imports

## Learn More

- [Gazelle Documentation](https://github.com/bazelbuild/bazel-gazelle)
- [rules_cue Documentation](https://github.com/abcue/rules_cue)
- [CUE Language](https://cuelang.org/)

